{% extends "base.html" %}
{% block styles %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/reading/our_library.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/writing/user-stories.css') }}">
{% endblock %}

{% block body %}
<div class="container user-stories our-library-container" >

    <!-- If No Story -->
    {% if stories|length == 0 %}
    <div class="no-stories p-4 rounded-4 text-center">
        <h3>ูุง ุชูุฌุฏ ูุตุต ุญุชู ุงูุงู!</h3>
        <p class="my-4 fs-5">ุงุจุฏุฃ ุงูุขู ุจูุชุงุจุฉ ูุตุชู ุงูุฃููู ูุดุงุฑููุง ุฎูุงูู ุงููุฏูุด.! ๐</p>
        <a href="../writing/writing-types"><button class="go-write button main-button mt-3">ุงุฐูุจ ูุตูุญุฉ ุงููุชุงุจุฉ</button></a>
    </div>
    {% endif %}

{% for story in stories %}
    <div class="story-box" >
                <!-- Cover Image -->
                {% if story['imgSrc'] is none or story['imgSrc'] | trim == "" %}
                <div class="no-cover cover">
                    ูุง ููุฌุฏ ุบูุงู
                </div>
                <div>{{ story['imgSrc'] }}</div>
                {% else %}
                <img class="cover" src="/static/{{ story['imgSrc'] }}" alt="ุตูุฑุฉ ุงูุบูุงู">
                {% endif %}

                <!-- Title -->
                {% if story['title'] == None %}
                <p>ุจุฏูู ุนููุงู</p>
                {% else  %}
                <p>{{story['title']}}</p>
                {% endif %}

                <!-- Story Type -->
                <p class="story-type" story-type="{{story['type']}}">ููุน ุงููุตุฉ: <span>{{story['type']}}</span></p>
                <div class="buttons text-center mt-3">
                    <button class="button main-button read-btn" id="{{story['id']}}"><i class="fa-solid fa-book-open"></i>ูุฑุงุกุฉ</button>
                    <button class="button main-button edit-user-story" id="{{story['id']}}"><i class="fa-solid fa-pencil"></i>ุชุนุฏูู</button>
                    <button class="button main-button delete-story" id="{{story['id']}}"><i class="fa-solid fa-trash-can"></i>ุญุฐู</button>
                </div>
        </div>
        
        {% endfor %}
    </div>
{% endblock %}
{% block script %}
<script>
    // Send Reding Type (user_stories) To Server
    document.querySelectorAll(".user-stories .story-box .buttons .read-btn").forEach(story => {
        story.addEventListener("click", async () => {
            try {
                const data = { message: ["user_stories",story.getAttribute('id')] }; 
                const response = await fetch('http://127.0.0.1:5000/reading/get-reading-type', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                });            
                if (!response.ok) {
                    throw new Error('ูุดู ุงูุงุชุตุงู ุจุงูุฎุงุฏู. ุญุงูู ูุฑุฉ ุฃุฎุฑู.');
                }
                const result = await response.json();
                if (result.redirect) {
                    // ุฅุนุงุฏุฉ ุงูุชูุฌูู ุฅูู ุงูุฑุงุจุท ุงููููุฏ
                    window.open(result.redirect, '_blank');
                }
            } catch (error) {
                console.error('ุญุฏุซ ุฎุทุฃ:', error);
            }
        })
    })

    
    // Click On Edit Story
    // @@@@@@@@@@@ Edit User Story @@@@@@@@@@@
	var allEditBtn = document.querySelectorAll(".buttons .edit-user-story");
    allEditBtn.forEach(btn => {
        btn.addEventListener("click", () => {
            // ุฅุนุงุฏุฉ ุงูุชูุฌูู ุฅูู ุตูุญุฉ ุงูุชุนุฏูู ูุน ูุนุฑู ุงููุตุฉ
            window.location.href = `/edit_user_story?storyID=${btn.getAttribute('id')}`;
        });
    })
    
    // Click On Delete Story
	var allDeleteBtn = document.querySelectorAll(".buttons .delete-story");
    allDeleteBtn.forEach(btn => {
        btn.addEventListener("click", async () => {
            // Warn Message
            Swal.fire({
                title: 'ุญุฐู ุงููุตุฉ',
                text: 'ูู ุฃูุช ูุชุฃูุฏ ุฃูู ุชุฑูุฏ ุญุฐู ูุฐู ุงููุตุฉ ูุง ูููู ุงูุชุฑุงุฌุน ุนู ูุฐุง ุงูุฅุฌุฑุงุก.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'ูุนูุ ุงุญุฐููุง',
                cancelButtonText: 'ุฅูุบุงุก',
                reverseButtons: true, // ุชุจุฏูู ุฃูุงูู ุงูุฃุฒุฑุงุฑ
            }).then(async (result)  => {
                if (result.isConfirmed) {
                    // Send Story ID
                    const data = { message: btn.getAttribute('id')  };
                    try {
                        // Show loading alert
                        Swal.fire({
                            title: 'ุฌุงุฑู ุญุฐู ูุตุชู...',
                            text: 'ุงูุฑุฌุงุก ุงูุงูุชุธุงุฑ ููููุงู',
                            allowOutsideClick: false,
                            showConfirmButton: false,
                            didOpen: () => {
                                Swal.showLoading(); // ุนุฑุถ ุงููุคุดุฑ ุงูุฏุงุฆุฑู
                            }
                        });
                        // Send data to the server
                        const response = await fetch('http://127.0.0.1:5000/delete-user-story', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data)
                        });
                        // Handle response
                        if (response.ok) {
                            Swal.fire('ุชู ุญุฐู ุงููุตุฉ!', '', 'success');
                            btn.closest('.story-box').remove(); // ุฅุฒุงูุฉ ุงููุตุฉ ูู ุงูุตูุญุฉ
                            return true;
                        } else {
                            Swal.fire({
                                title: 'ูุดู ุญุฐู ุงููุตุฉ',
                                text: 'ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญุฏูุซ ุงููุตุฉ.',
                                icon: 'error',
                                confirmButtonText: 'ุญุงูู ูุฑุฉ ุฃุฎุฑู'
                            });
                        }
                    } catch (error) {
                        Swal.fire({
                            title: 'ูุดู ุงูุญุฐู',
                            text: 'ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุชูุงุตู ูุน ุงูุฎุงุฏู',
                            icon: 'error',
                            confirmButtonText: 'ุญุณูุง' // ุชุบููุฑ ุงููุต ุฅูู "ุญุณูุง"
                        });
                        console.error(error);
                    }




                } else {
                    console.log('ุชู ุฅูุบุงุก ุนูููุฉ ุงูุญุฐู.');
                }
            });
        });


    })
    
</script>
{% endblock %}
