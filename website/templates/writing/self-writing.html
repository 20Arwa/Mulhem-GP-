{% extends "base.html" %}
{% block title %}ุงููุฑู ุจูู ุงููุชุงุจุฉ ุงููุตุตูุฉ ูุงูุฅุจุฏุงุนูุฉ{% endblock %}
{% block styles %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/writing/self-writing.css') }}">
{% endblock %}
{% block body %}
<div class="container self-writing my-5 rounded-4 p-4 position-relative">
	<div class="book-container position-relative">
		<i id="prevButton" class="fa-regular fa-circle-right position-absolute top-50 end-0 me-3 z-3"></i>
		<i id="nextButton" class="fa-regular fa-circle-left position-absolute top-50 start-0 ms-3 z-3"></i>
		<div class="scene">
				<article class="book">
					<section class="page active">
						<div class="front">
							<input class="button" type="text" name="title" placeholder="ุนููุงู ุงููุตุฉ" class="">
							<div class="cover-img-container img-container">
								<div class="rounded-4">
									<img class="img cover-img" src="" alt=""> 
								</div>
								<label for="cover-description">ุฃุฏุฎู ูุตู ุงูุตูุฑุฉ</label>
								<textarea class="w-100 h-75 rounded-3" type="text" id="cover-description" placeholder="ูุซุงู:ููุฏ ุตุบูุฑ ูุฑุญ ุจุดุนุฑ ูุฌุนุฏ ูุฑุชุฏู ุณุชุฑุฉ ุฒุฑูุงุกุ ูููู ุชุญุช ุดุฌุฑุฉ ุจุฃูุฑุงู ุฎุถุฑุงุก ูุชููุฌุฉ. ูู ุงูุฎูููุฉุ ุณูุงุก ุฒุฑูุงุก ูุน ุณุญุจ ุจูุถุงุก ูุฃุฑูุจ ูุทูู ูููุฒ ุจุงููุฑุจ." ></textarea>
							</div>
						</div>
						<div class="back">
							<div class="text" contenteditable="true"></div>
							<div class="correction-word" title="ุงููุฑ ููุชุตุญูุญ"></div>
							<div class="counter-sound">
								<div class="text-counter">ุนุฏุฏ ุงูุฃุญุฑู: <span id="charCount">0</span>/<span id="maxLength">500</span></div>
								<audio class="text-audio" controls controlslist="nodownload noplaybackrate">
									<source id="audioSource" src="../../static/audio/tem.mp3" type="audio/mpeg">
									ุงููุชุตูุญ ุงูุฎุงุต ุจู ูุง ูุฏุนู ุนูุตุฑ ุงูุตูุช
								</audio>
							</div>
							<span id="error-msg">ููุฏ ูุตูุช ุฅูู ุงูุญุฏ ุงูุฃูุตู ูู ุงูุญุฑูู. ุฃุถู ุตูุญุฉ ุฌุฏูุฏุฉ.</span>
						</div>
					</section>
					<section class="page">
						<div class="front">
							<div class="cover-img-container img-container">
								<img class="img cover-img" src=""> 
							</div>
							<div class="error-msg">ุงูุชุจ ุงููุฒูุฏ ูุชุญุตู ุนูู ุงูุตูุฑุฉ</div>
							<button class="generate-btn button">ุฃูุดุฆ ุตูุฑุฉ</button>
						</div>
						<div class="back">
							<div class="text" contenteditable="true"></div>
							<div class="text-counter">ุนุฏุฏ ุงูุฃุญุฑู: <span id="charCount">0</span>/<span id="maxLength">500</span><span id="error-msg">ููุฏ ูุตูุช ุฅูู ุงูุญุฏ ุงูุฃูุตู ูู ุงูุญุฑูู. ููููู ุฅุถุงูุฉ ุตูุญุฉ ุฌุฏูุฏุฉ ูููุชุงุจุนุฉ.</span></div>
							<div class="correction-word" title="ุงููุฑ ููุชุตุญูุญ"></div>
							<i class="fa-solid fa-volume-high"></i>
						</div>
					</section>
				</article>
			</div>
		</div>
		
		
		<div class="sitting-buttons mt-4">
			<div class="sitting-error-msg error-msg mb-2">ุฑุณุงูุฉ ุงูุฎุทุฃ</div>
			<div class="d-flex align-items-center justify-content-center column-gap-2">
				<button class="add-page-icon">
					<i class="fa-solid fa-circle-plus"></i>
					ุฅุถุงูุฉ ุตูุญุฉ
				</button>
				<button class="delete-page-icon" disabled>
					<i class="fa-solid fa-circle-minus"></i>
					ุญุฐู ุตูุญุฉ
				</button>
	
				
				<div class="dropdown allam-help">
					<button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
						<i class="fa-solid fa-circle-question"></i>
						ุงุทูุจ ูุณุงุนุฏุฉ ูููููู
					</button>
					<ul class="dropdown-menu text-center">
						<li><a class="dropdown-item starting">ูุง ุฃุนุฑู ุนู ูุงุฐุง ุฃูุชุจ</a></li>
						<li><a class="dropdown-item completion">ูุง ุฃุนุฑู ููู ุฃููู ูุตุชู</a></li>
						<li><a class="dropdown-item correction" href="#allam-response">ุตุญุญ ุฃุฎุทุงุฆู</a></li>
						<li><a class="dropdown-item elements" href="#allam-response">ุชุญูู ูู ุนูุงุตุฑ ูุตุชู</a></li>
					</ul>
				</div>

				<div class="record d-flex flex-column align-items-center">
					<div class="display-voice-record"></div>
					<div class="d-flex">
						<div class="controllers-voice-record"></div>
					</div>
				</div>
				
				<!-- <button class="later-btn"><i class="fa-solid fa-stopwatch"></i>ุณุฃููู ูุงุญูุง</button> -->
				<button class="out-btn"><i class="fa-solid fa-right-from-bracket"></i>ุฎุฑูุฌ</button>
			</div>
		</div>


	


		<!-- @@@@@@@@@@@@@ Starting Ideas @@@@@@@@@@@@ -->
		<div class="response response-starting p-4 mx-auto mt-5 bg-white rounded-4 position-relative text-center" id="starting-ideas">
			<i class="fa-solid fa-circle-xmark close-icon position-absolute"></i>
			<div class="d-flex justify-content-between mb-5">
				<h3>โจุฃููุงุฑ ุฌูููุฉ ูุชูุชุจ ุนููุง</h3>
			</div>
			<div id="carouselIdeas" class="carousel slide mt-5 p-3 rounded-4">
				<div class="carousel-indicators">
					<button type="button" data-bs-target="#carouselIdeas" data-bs-slide-to="0" class="active" aria-current="true" aria-label="Slide 1"></button>
					<button type="button" data-bs-target="#carouselIdeas" data-bs-slide-to="1" aria-label="Slide 2"></button>
					<button type="button" data-bs-target="#carouselIdeas" data-bs-slide-to="2" aria-label="Slide 3"></button>
					<button type="button" data-bs-target="#carouselIdeas" data-bs-slide-to="3" aria-label="Slide 4"></button>
					<button type="button" data-bs-target="#carouselIdeas" data-bs-slide-to="4" aria-label="Slide 5"></button>
					<button type="button" data-bs-target="#carouselIdeas" data-bs-slide-to="5" aria-label="Slide 6"></button>
					<button type="button" data-bs-target="#carouselIdeas" data-bs-slide-to="6" aria-label="Slide 7"></button>
					<button type="button" data-bs-target="#carouselIdeas" data-bs-slide-to="7" aria-label="Slide 8"></button>
					<button type="button" data-bs-target="#carouselIdeas" data-bs-slide-to="8" aria-label="Slide 9"></button>
					<button type="button" data-bs-target="#carouselIdeas" data-bs-slide-to="9" aria-label="Slide 10"></button>
				  </div>
				<div class="carousel-inner">
					<div class="carousel-item active">
						<h4>๐๐ ููู ูู ุญูุงุชู  ๐๐</h4>
						<p>ุงูุชุจ ุนู ุฃูุซุฑ ุดูุก ูููุฒ ุฃู ูุฎุชูู ุญุฏุซ ุงููููุ ุณูุงุก ูุงู ุฌูุฏูุง ุฃู ุณูุฆูุง</p>
					</div>
					<div class="carousel-item">
						<h4>๐๐ ูููู ุฌุนูู ุณุนูุฏูุง ๐๐</h4>
						<p>ุงุญูู ุนู ูุญุธุฉ ุดุนุฑุช ูููุง ุจุงูุณุนุงุฏุฉ.</p>
					</div>
					<div class="carousel-item">
						<h4>๐งโ๐คโ๐งโจ ูุตุฉ ุนู ุตุฏููู ุงูููุฑุจ โจ๐งโ๐คโ๐ง</h4>
						<p>ุงูุชุจ ุนู ูุบุงูุฑุฉ ุฃู ูููู ููุชุน ุนุดุชู ูุน ุตุฏููู ุงูููุถู.</p>
					</div>
					<div class="carousel-item">
						<h4>๐ถ๐ฑ ุญููุงู ููุถู ๐ฑ๐ถ</h4>
						<p>ุงูุชุจ ุนู ุญููุงูู ุงูููุถู. ูุงุฐุง ููุนูุ ุฃูู ูุนูุดุ</p>
					</div>
					<div class="carousel-item">
						<h4>๐๐๏ธ ุฑุญูุฉ ููุช ุจูุง ๐๏ธ๐</h4>
						<p>ุงุญูู ุนู ููุงู ุฐูุจุช ุฅููู ูุน ุนุงุฆูุชู ุฃู ุฃุตุฏูุงุฆู ููุง ุงูุฐู ุฃุญุจุจุชู ูู ุงูุฑุญูุฉ.</p>
					</div>
					<div class="carousel-item">
						<h4>๐๐ฏ ุญูู ุชุชููู ุชุญูููู ๐ฏ๐</h4>
						<p>ุงุญูู ุนู ุดูุก ุชุญูู ุจุชุญูููู ูู ุงููุณุชูุจู.</p>
					</div>
					<div class="carousel-item">
						<h4>๐ฆธโโ๏ธ๐ก๏ธ ูุบุงูุฑุฉ ุฎูุงููุฉ ๐ก๏ธ๐ฆธโโ๏ธ</h4>
						<p>ุชุฎูู ูุตุฉ ุนู ุจุทู ุฎุงุฑู ุฃู ูุบุงูุฑุฉ ูููุฆุฉ ุจุงูุฅุซุงุฑุฉ ูุงูุฎูุงู.</p>
					</div>
					<div class="carousel-item">
						<h4>๐๏ธ๐ ุฑุญูุฉ ูู ุงูุทุจูุนุฉ ๐๐๏ธ</h4>
						<p>ุชุฎูู ุฃูู ุนูุตุฑ ูู ุงูุทุจูุนุฉุ ูุซู ุงูุฑูุงุญ ุฃู ุงููุทุฑุ ูุงุญูู ูุตุชู.</p>
					</div>
					<div class="carousel-item">
						<h4>๐ป๐ต ุฌูุงู ุงููุจุงุชุงุช ๐ต๐ป</h4>
						<p>ุชุญุฏุซ ุนู ูุจุงุช ุฃู ุฒูุฑุฉ ููุง ุชูุฑ ุจู ุฎูุงู ููููุง.</p>
					</div>
					<div class="carousel-item">
						<h4>๐๐ญ ุญูู ุบุฑูุจ ๐ญ๐</h4>
						<p>ุงุญูู ุนู ุญูู ุบุฑูุจ ุฃู ููุชุน ุฑุฃูุชู ุฃุซูุงุก ูููู.</p>
					</div>
					
				</div>
				<button class="carousel-control-prev" type="button" id="carouselPrev"  data-bs-target="#carouselIdeas" data-bs-slide="prev">
					<i class="fa-regular fa-circle-right"></i>
					<span class="visually-hidden">Previous</span>
				</button>
				<button class="carousel-control-next" type="button" id="carouselNext" data-bs-target="#carouselIdeas" data-bs-slide="next">
					<i class="fa-regular fa-circle-left"></i>
					<span class="visually-hidden">Next</span>
				</button>
			</div>
		</div>

		<!--  -->
		<div class="response response-elements p-4 mx-auto mt-5 bg-white rounded-4 position-relative text-center" id="elements">
			<i class="fa-solid fa-circle-xmark close-icon position-absolute"></i>
			<div class="d-flex justify-content-between mb-5">
				<h3>ุงูุชุญูู ูู ุนูุงุตุฑ ุงููุตุฉ๐โจ:</h3>
			</div>
			<div class="elements">
			</div>
		</div>

	</div>
</div>
{% endblock %}
{% block script %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>

<script type="module">
document.addEventListener('DOMContentLoaded', function () {
	const addPageBtn = document.querySelector(".add-page-icon"); // Add Page Button
	const deletePageBtn = document.querySelector(".delete-page-icon"); // Delete Page Button

	const nextButton = document.getElementById('nextButton'); // Next Page Button
	const prevButton = document.getElementById('prevButton'); // Prev Page Button
	
	nextButton.addEventListener('click', nextPage);
	prevButton.addEventListener('click', prevPage);

	// @@@@@@@@@@@ Next Page Button @@@@@@@@@@@
	function nextPage() {
		prevButton.style.display = "inline-block"; // Display Prev Button
	
		const activePage = document.querySelector('.page.active');
		if (activePage) {
			const nextPage = activePage.nextElementSibling;
			
			// ุงุฌุนู ุงูุตูุญุฉ ุงููุดุทุฉ ููููุจุฉ
			activePage.classList.remove('active');
			activePage.classList.add('flipped');
			
			// ุชุญูู ุฅุฐุง ูุงูุช ุงูุตูุญุฉ ุงูุชุงููุฉ ููุฌูุฏุฉ
			if (nextPage && nextPage.classList.contains('page')) {
				nextPage.classList.add('active'); // ุงุฌุนู ุงูุตูุญุฉ ุงูุชุงููุฉ ูุดุทุฉ
				
				// ุชุนุฑูู ุงููุชุบูุฑ ุจุนุฏ ุงูุตูุญุฉ ุงูุชุงููุฉ
				const afterNextPage = nextPage.nextElementSibling;
				
				if (!afterNextPage || !afterNextPage.classList.contains('page')) {
					nextButton.style.display = "none";
				} else {
					nextButton.style.display = "inline-block";
				}
				
				// Add Page Btn
				// ุชุญูู ุฅุฐุง ูุงู ุนุฏุฏ ุงูุตูุญุงุช 20
				const allPages = document.querySelectorAll('.page');
				const errorMsg = document.querySelector(".sitting-error-msg");
				if (allPages.length > 20) {
					nextButton.style.display = "none";
					addPageBtn.setAttribute('disabled', 'disabled'); 
				}
				else {
					addPageBtn.removeAttribute('disabled'); 
				}
					
				// Delete Page Btn
				const activePageIndex = Array.from(allPages).indexOf(nextPage);

				if (activePageIndex === 1) { 
					// ุชูููู ุงูุฒุฑ ุฅุฐุง ูุงูุช afterNextPage ุชุญุชูู ุนูู ุงูุตูุญุงุช ุงููุทููุจุฉ
					deletePageBtn.disabled = !(afterNextPage && afterNextPage.classList.contains('page')); 
				} 
				else if (activePageIndex > 1) {
					// ุชูููู ุงูุฒุฑ ููุตูุญุงุช ุจุนุฏ ุงูุตูุญุฉ ุงูุซุงููุฉ
					deletePageBtn.removeAttribute('disabled'); 
				} 
				else {
					// ุชุนุทูู ุงูุฒุฑ ูุฃู ุญุงูุฉ ุฃุฎุฑู
					deletePageBtn.setAttribute('disabled', 'disabled'); 
				}
			}
		}
	}
	
	// @@@@@@@@@@@ Prev Page Button @@@@@@@@@@@
	function prevPage() {
		const flippedPages = document.querySelectorAll('.page.flipped');
		const activePage = document.querySelector('.page.active');
		const previousPage = activePage.previousElementSibling;
		
		nextButton.style.display = "inline-block"; // Display Next Btn

		// If Prev Page Was The Cover, Hide PRev Btn And Delete
		const beforePreviousPage = previousPage.previousElementSibling;
		if (!beforePreviousPage || !beforePreviousPage.classList.contains('page')) {
			prevButton.style.display = "none"; // Hide Prev Button
			deletePageBtn.setAttribute('disabled', 'disabled'); // Disabled Delete Page Button
			
		}
		
		// Move The Page
		if (flippedPages.length > 0) {
			// ุงุฌุนู ุขุฎุฑ ุตูุญุฉ ููููุจุฉ ูุดุทุฉ ูุฑุฉ ุฃุฎุฑู
			const lastFlippedPage = flippedPages[flippedPages.length - 1];
			lastFlippedPage.classList.remove('flipped');
			lastFlippedPage.classList.add('active');
			
			// ุฅุฒุงูุฉ ุญุงูุฉ ุงููุดุท ูู ุฌููุน ุงูุตูุญุงุช ุงูุฃุฎุฑู
			const allPages = document.querySelectorAll('.page');
			allPages.forEach((page) => {
				if (page !== lastFlippedPage) {
					page.classList.remove('active');
				}
			});
		}
	}
	
	// @@@@@@@@@@@ Add Page Button @@@@@@@@@@@
	addPageBtn.addEventListener("click", () => {
		const book = document.querySelector(".book");
		const newPage = document.createElement("section");
		newPage.className = "page"; // ุฃุถู ูุฆุฉ "page"
		newPage.innerHTML = `
			<div class="front">
				<div class="cover-img-container img-container">
					<img class="img cover-img" src=""> 
				</div>
				<button class="generate-btn button">ุฃูุดุฆ ุตูุฑุฉ</button>
			</div>  
			<div class="back">
				<div class="text" contenteditable="true"></div>
				<div class="text-counter">
					ุนุฏุฏ ุงูุฃุญุฑู: <span id="charCount">0</span>/<span id="maxLength">500</span>
					<span id="error-msg">ููุฏ ูุตูุช ุฅูู ุงูุญุฏ ุงูุฃูุตู ูู ุงูุญุฑูู. ููููู ุฅุถุงูุฉ ุตูุญุฉ ุฌุฏูุฏุฉ ูููุชุงุจุนุฉ.</span>
				</div>
				<div class="correction-word" title="ุงููุฑ ููุชุตุญูุญ"></div>
				<i class="fa-solid fa-volume-high"></i>
			</div>
		`; 
		book.appendChild(newPage); // ุฃุถู ุงูุตูุญุฉ ุงูุฌุฏูุฏุฉ ุฅูู ุงููุชุงุจ
		nextPage(); // ุงูุงูุชูุงู ุฅูู ุงูุตูุญุฉ ุงูุชุงููุฉ


		// Click New Generate Image Button
		newPage.querySelector(".generate-btn").addEventListener("click", (e) => {
			e.preventDefault(); // Prevent page reload
			sendTextGetImage();
	})
	});
	

	// @@@@@@@@@@@ Delete Page Button @@@@@@@@@@@	
	deletePageBtn.addEventListener("click", () => {
		Swal.fire({
			title: 'ุญุฐู ุงูุตูุญุฉ',
			text: 'ูู ุฃูุช ูุชุฃูุฏ ุฃูู ุชุฑูุฏ ุญุฐู ูุฐู ุงูุตูุญุฉุ ูุง ูููู ุงูุชุฑุงุฌุน ุนู ูุฐุง ุงูุฅุฌุฑุงุก.',
			icon: 'warning',
			showCancelButton: true,
			confirmButtonText: 'ูุนูุ ุงุญุฐููุง',
			cancelButtonText: 'ุฅูุบุงุก',
			reverseButtons: true, // ุชุจุฏูู ุฃูุงูู ุงูุฃุฒุฑุงุฑ
		}).then((result) => {
			if (result.isConfirmed) {
				const currentSection = document.querySelector(".page.active");
				if (currentSection) {
					// ุงูุงูุชูุงู ุฅูู ุงูุตูุญุฉ ุงูุณุงุจูุฉ
					prevPage();
	
					// ุชุญุฏูุซ ุญุงูุฉ ุงูุฃุฒุฑุงุฑ ุจุนุฏ ุงูุญุฐู
					const activePage = document.querySelector('.page.active');
					const previousPage = activePage.previousElementSibling;
					const beforePreviousPage = previousPage?.previousElementSibling;
	
					if (!beforePreviousPage || !beforePreviousPage.classList.contains('page')) {
						nextButton.style.display = "none"; // ุฅุฎูุงุก ุฒุฑ ุงูุตูุญุฉ ุงูุชุงููุฉ
						deletePageBtn.setAttribute('disabled', 'disabled'); // ุชุนุทูู ุฒุฑ ุงูุญุฐู
					}
	
					// ุญุฐู ุงูุตูุญุฉ ุงูุญุงููุฉ
					currentSection.remove();
					console.log('ุชู ุญุฐู ุงูุตูุญุฉ.');
				} else {
					Swal.fire({
						icon: 'error',
						title: 'ุฎุทุฃ',
						text: 'ูุง ุชูุฌุฏ ุตูุญุฉ ูุดุทุฉ ูุญุฐููุง!',
					});
				}
			} else {
				console.log('ุชู ุฅูุบุงุก ุนูููุฉ ุงูุญุฐู.');
			}
		});
	});
	


	// @@@@@@@@@@@ @@@@@@@@@@@ Recive And Send Data To Python @@@@@@@@@@@ @@@@@@@@@@@
	// @@@@@@@@@@@ Generate Image @@@@@@@@@@@
	async function sendTextGetImage() {
		const img = document.querySelector(".page.active .front img");
		var textElement = document.querySelector(".page.active").previousElementSibling.querySelector(".back .text");

		// Check Text Length
		if (textElement.textContent.length < 25) {
			document.querySelector(".front .error-msg").style.opacity = 1;
			return;
		}
		document.querySelector(".front .error-msg").style.opacity = 0;

		const data = { message: textElement.textContent }; // Corrected line
	
		const response = await fetch('http://127.0.0.1:5000/generate-img', {
			method: 'POST',
			headers: { 'Content-Type': 'application/json' },
			body: JSON.stringify(data)
		});
	
		if (response.ok) {
			const result = await response.json();
			console.log(result.response);
		} else {
			console.error(`Error: ${response.statusText}`);
		}
	}
	// Click Generate Image Button
	document.querySelectorAll(".generate-btn").forEach(btn => {
		btn.addEventListener("click", (e) => {
			e.preventDefault(); // Prevent page reload
			sendTextGetImage();
		});
	})
	
	
	// @@@@@@@@@@@ Generate Audio @@@@@@@@@@@
	//async function sendTextGetAudio() {    }

	
	// @@@@@@@@@@@ Allam Correction @@@@@@@@@@@
	async function allamCorrection() {  
		var sittingErrMsg = document.querySelector(".sitting-error-msg");
		// Check If Cover Page
		if (document.querySelector(".page.active") == document.querySelector(".page:first-of-type")) {
			sittingErrMsg.innerHTML = "ูุง ูููู ุงููุฑุงุฌุนุฉ ูุงูุชุตุญูุญ ูู ุตูุญุฉ ุงูุบูุงู";
			sittingErrMsg.style.opacity = 1;
			setTimeout(() => {sittingErrMsg.style.opacity = 0;}, 5000); 
			return ;
		}
		
		// If Text Is Empty
		var textElement = document.querySelector(".page.active").previousElementSibling.querySelector(".back .text");
		if (textElement.textContent.length == 0) {
			sittingErrMsg.innerHTML = "ูุง ููุฌุฏ ูุต ููุฑุงุฌุนุชูุ ุฃุถู ูุตุงู ุฃููุงู"
			sittingErrMsg.style.opacity = 1;
			setTimeout(() => {sittingErrMsg.style.opacity = 0;}, 5000); 
			return;
		}
		// If Text Is Short
		else if (textElement.textContent.length < 20) {
			sittingErrMsg.innerHTML = "ุงููุตุฉ ูุตูุฑุฉ ุฌุฏุง! ุญุงูู ูุชุงุจุฉ ุงููุฒูุฏ ูุชุญุตู ุนูู ุงูุชุตุญูุญ"
			sittingErrMsg.style.opacity = 1;
			setTimeout(() => {sittingErrMsg.style.opacity = 0;}, 5000); 
			return;
		}
		else {
			sittingErrMsg.style.opacity = 0; // Remove Error Message
		}

		// Send To Allam
		const data = { message: textElement.textContent }; 
		var result = "";
	
		const response = await fetch('http://127.0.0.1:5000/allam-correction', {
			method: 'POST',
			headers: { 'Content-Type': 'application/json' },
			body: JSON.stringify(data)
		});
	
		if (response.ok) {
			result = await response.json();

			// $$$$$$ If No Errors $$$$$$ 
			if (Object.keys(result.response).length === 0) {
				Swal.fire({
					title: 'ุฑุงุฆุน ุฌุฏุง!',
					text: 'ูุตู ุฎุงูู ูู ุงูุฃุฎุทุงุกุ ุนููู ููุชุงุฒ! ๐',
					icon: 'success',
					confirmButtonText: 'ุนูุฏุฉ ูููุชุงุจุฉ',
					reverseButtons: true, 
				})
				return;
			}
			else {
				Swal.fire({
					title: 'ุฃุญุณูุช!',
					text: 'ููู ููุงู ุจุนุถ ุงูุฃุฎุทุงุก ุงูุตุบูุฑุฉ. ุงุถุบุท ุนูู ุงูุฃุฌุฒุงุก ุงููููููุฉ ูุชุตุญูุญูุง ูุชุญุณูู ูุตุชู',
					icon: 'info',
					confirmButtonText: 'ุงูุนูุฏุฉ ูุชุตุญูุญ ุงูุฃุฎุทุงุก',
					reverseButtons: true,
				})
			}

			// $$$$$$ Spelling $$$$$$
			var spellings = result.response.spelling;
			let text = textElement.innerHTML;
			function highlightSpellingErrors(textElement, spellings) {
				const textContent = textElement.textContent; // ุงููุต ุงููุงูู
				const words = textContent.split(/(\s+|[,.!?ุุ])/); // ุชูุณูู ุงููุต ุฅูู ูููุงุช ูุนูุงูุงุช ุงูุชุฑููู
			
				// ุฅูุดุงุก ูุญุชูู ุฌุฏูุฏ ูุน ุงูุฃุฎุทุงุก ุงููุญุฏุฏุฉ
				const newContent = words.map(word => {
					const spelling = spellings.find(sp => sp[0] === word); // ุงูุจุญุซ ุนู ุงููููุฉ ูู ูุงุฆูุฉ ุงูุฃุฎุทุงุก
					if (spelling) {
						// ุฅุฐุง ูุงูุช ุงููููุฉ ุฎุงุทุฆุฉุ ุฅูุดุงุก <span>
						const span = document.createElement("span");
						span.className = "spelling-error position-relative";
						span.dataset.suggestion = spelling[1];
						span.textContent = spelling[0];
						return span.outerHTML; // ุชุญููู ุงูุนูุตุฑ ุฅูู ูุต HTML
					}
					return word; // ุงููููุฉ ุตุญูุญุฉ ุชูุชุฑู ููุง ูู
				}).join(''); // ุฅุนุงุฏุฉ ุชุฌููุน ุงููุตูุต
			
				// ุงุณุชุจุฏุงู ุงููุต ูู ุงูุนูุตุฑ
				textElement.innerHTML = newContent;
			}
			// ุชุทุจูู ุงูุฏุงูุฉ
			highlightSpellingErrors(textElement, spellings);

			var correctionWord = document.querySelector(".back .correction-word")

			textElement.addEventListener('mouseover', (e) => {
				if (e.target.classList.contains('spelling-error')) {
					correctionWord.style.display = 'block';
					correctionWord.textContent = `ุงููููุฉ ุงูุตุญูุญุฉ: ${e.target.dataset.suggestion}`;
			
					// ุฅุถุงูุฉ ุญุฏุซ ุงูููุฑ ูุชุนุฏูู ุงููููุฉ ุงููุญุฏุฏุฉ ููุท
					correctionWord.onclick = () => {
						e.target.textContent = e.target.dataset.suggestion;
						e.target.classList.remove('spelling-error');
						correctionWord.style.display = 'none';
					};
				}
			});

			// $$$$$$ Grammer $$$$$$ ููุณ ุงููู ููู ุจุณ ุงุบูุฑ ุงุณู ุงูุณุจูููุ ูุงูุงูุฑูุฑ ุงูุงุฒุฑู ุญูู

			// $$$$$$ Inappropriate Words $$$$$$

		} else {
			console.error(`Error: ${response.statusText}`);
		}
	}
	// Click Correction Button
	document.querySelector(".dropdown.allam-help .correction").addEventListener("click", (e) => {
		e.preventDefault(); // Prevent page reload
		allamCorrection();
	});

	// @@@@@@@@@@@ Allam Elements @@@@@@@@@@@
	async function allamElements() {  
		var sittingErrMsg = document.querySelector(".sitting-error-msg");
	
		// Get All Text
		var AllStory = document.querySelectorAll(".back .text");
		var fullStory = "";
		AllStory.forEach(text => {fullStory += text.textContent.trim() + " "})
		
		// If Text Is Empty
		if (fullStory.trim().length == 0) {
			sittingErrMsg.innerHTML = "ูุง ููุฌุฏ ูุต ููุชุญูู ูููุ ุฃุถู ูุตุงู ุฃููุงู"
			sittingErrMsg.style.opacity = 1;
			setTimeout(() => {sittingErrMsg.style.opacity = 0;}, 5000); 
			return;
		}
		// If Text Is Short
		else if (fullStory.length < 200) {
			sittingErrMsg.innerHTML = "ุงููุตุฉ ูุตูุฑุฉ! ุญุงูู ูุชุงุจุฉ ุงููุฒูุฏ ูุชูููู ุงูุชุญูู"
			sittingErrMsg.style.opacity = 1;
			setTimeout(() => {sittingErrMsg.style.opacity = 0;}, 5000); 
			return;
		}
		else {
			sittingErrMsg.style.opacity = 0; // Remove Error Message
		}

		// Send To Allam
		const data = { message: fullStory }; 
		var result = "";
	
		const response = await fetch('http://127.0.0.1:5000/allam-elements', {
			method: 'POST',
			headers: { 'Content-Type': 'application/json' },
			body: JSON.stringify(data)
		});
	
		if (response.ok) {
			result = await response.json();

			// $$$$$$ If All Elements Exist $$$$$$ 
			if (result.response["ุงูุนูุงุตุฑ ููุชููุฉ"] == "True") {
				Swal.fire({
					title: 'ุฑุงุฆุน ุฌุฏุง!',
					text: 'ูุตุชู ุชุญุชูู ุนูู ุฌููุน ุนูุงุตุฑ ุงููุตุฉ. ุฃุญุณูุช! ๐',
					icon: 'success',
					confirmButtonText: 'ุชููุฏ ุนูุงุตุฑ ูุตุชู',
					reverseButtons: true, 
				})
			}
			else {
				Swal.fire({
					title: 'ุฃุญุณูุช!',
					text: 'ููู ููุงู ุจุนุถ ุงูุนูุงุตุฑ ุงููุงูุตุฉ. ุงูุธุฑ ุฅูู ุงูุงูุชุฑุงุญุงุช ูุชููููุง',
					icon: 'info',
					confirmButtonText: 'ุชููุฏ ุนูุงุตุฑ ูุตุชู',
					reverseButtons: true,
				})
			}

			// Show Response To User
			var responseElemsContainer = document.querySelector(".response-elements");
			responseElemsContainer.style.display = "block"; // Display Response
			// Go Down To Elements
			const offset = window.innerHeight * 0.1; // 10% ูู ุงุฑุชูุงุน ุงูุดุงุดุฉ
			window.scrollTo({ 
				top: responseElemsContainer.getBoundingClientRect().top + window.pageYOffset - offset, 
				behavior: 'smooth' 
			});

			const elementOrder = ["ุงูุดุฎุตูุงุช", "ุงูููุงู", "ุงูุฒูุงู", "ุงูุฃุณุจุงุจ", "ุงููุนุถูุฉ"]; // ูุงุฆูุฉ ุชุฑุชูุจ ุงูุนูุงุตุฑ
			const responseElems = document.querySelector(".response-elements .elements");
			
			// ุฃุถู ุงูุนูุงุตุฑ ุจุงูุชุฑุชูุจ
			elementOrder.forEach(key => {
				if (key in result.response) {
					const elementDiv = document.createElement("div"); // ุฅูุดุงุก div ููู ุนูุตุฑ
					// ุฅูุดุงุก ุนููุงู h5
					const title = document.createElement("h5");
					title.innerHTML = key;
					// ุฅูุดุงุก ููุฑุฉ p
					const paragraph = document.createElement("p");
					paragraph.innerHTML = `: &nbsp${result.response[key]}`;
					// ุฑุจุท ุงูุนูุงุตุฑ
					elementDiv.appendChild(title);
					elementDiv.appendChild(paragraph);
					responseElems.appendChild(elementDiv); // ุฅุถุงูุฉ div ุฅูู ุงูู container
				}
			});
		} else {
			console.error(`Error: ${response.statusText}`);
		}
	}
	// Click Elements Button
	document.querySelector(".dropdown.allam-help .elements").addEventListener("click", (e) => {
		e.preventDefault(); // Prevent page reload
		allamElements();
	});
	// Click On Close elements
	document.querySelector(".response-elements .close-icon").addEventListener("click", () => {
		document.querySelector(".response-elements").style.display = "none";
		window.scrollBy({top: -420});	
	});



	// @@@@@@@@@@@ Starting Ideas @@@@@@@@@@@
	var startingIdeas = document.querySelector(".response-starting");
	var dropdownStart = document.querySelector(".dropdown.allam-help .starting");
	dropdownStart.addEventListener("click", (e) => {
		e.preventDefault();
		startingIdeas.style.display = "block"; // Display Ideas
		
		// Go Down To Ideas
		const offset = window.innerHeight * 0.1; // 10% ูู ุงุฑุชูุงุน ุงูุดุงุดุฉ
		window.scrollTo({ 
			top: document.querySelector('#starting-ideas').getBoundingClientRect().top + window.pageYOffset - offset, 
			behavior: 'smooth' 
		});
	});
	// Click On Close Ideas
	document.querySelector(".response-starting .close-icon").addEventListener("click", () => {
		startingIdeas.style.display = "none";
		window.scrollBy({top: -420});	
	});
	


	// @@@@@@@@@@@ Out Button @@@@@@@@@@@
	document.querySelector(".out-btn").addEventListener("click", () => {
		// Save Story In data base
	})


	// @@@@@@@@@@@ Text Characters Counter @@@@@@@@@@@
	document.querySelectorAll(".page").forEach((page) => {
		const textElement = page.querySelector(".back .text");
		const charCounter = page.querySelector(".back .text-counter #charCount");
		const maxLength = Number(page.querySelector(".back .text-counter #maxLength").textContent);
		const errorMsg = page.querySelector(".back #error-msg");
	
		if (textElement) {
			let timeout;
	
			// ุญุฏุซ ุงูุฅุฏุฎุงู
			textElement.addEventListener('input', () => {
				clearTimeout(timeout); // ุฅูุบุงุก ุงููุคูุช ุงูุณุงุจู
				timeout = setTimeout(() => {
					const currentText = textElement.textContent;
	
					// ุฅุฐุง ุชุฌุงูุฒ ุงููุต ุงูุญุฏ ุงูุฃูุตู
					if (currentText.length > maxLength) {
						textElement.textContent = currentText.slice(0, maxLength); // ูุทุน ุงููุต ุฅูู ุงูุญุฏ ุงูุฃูุตู
						if (errorMsg) errorMsg.style.opacity = 1;
	
						// ุฅุนุงุฏุฉ ุงููุคุดุฑ ุฅูู ููุงูุฉ ุงููุต
						const range = document.createRange();
						const selection = window.getSelection();
						range.selectNodeContents(textElement);
						range.collapse(false);
						selection.removeAllRanges();
						selection.addRange(range);
					} else {
						if (errorMsg) errorMsg.style.opacity = 0;
					}
	
					// ุชุญุฏูุซ ุนุฏุงุฏ ุงูุฃุญุฑู
					if (charCounter) charCounter.textContent = textElement.textContent.length;
				}, 100); // ุชุฃุฎูุฑ ุจุณูุท ูุชุญุณูู ุงูุฃุฏุงุก
			});
	
			// ููุน ูุตู ุงููุตูุต ุงูุชู ุชุชุฌุงูุฒ ุงูุญุฏ ุงูุฃูุตู
			textElement.addEventListener('paste', (event) => {
				event.preventDefault();
				let pastedText = event.clipboardData.getData('text').slice(0, maxLength - textElement.textContent.length);
				document.execCommand('insertText', false, pastedText);
			});
		}
	});
	
	
	// @@@@@@@@@@@ Text Sitting @@@@@@@@@@@
	// ุชูุญูุฏ ุณุชุงูู ุงููุต ุฏุงุฎู ุตูุญุฉ ุงููุชุงุจุฉ
	document.querySelector(".page .back .text").addEventListener('paste', (event) => {
        event.preventDefault(); // ููุน ุงูุณููู ุงูุงูุชุฑุงุถู
        const text = (event.clipboardData || window.clipboardData).getData('text/plain');  // ุงูุญุตูู ุนูู ุงููุต ุงูุฎุงู ูู ุงูุญุงูุธุฉ
        document.execCommand('insertText', false, text); // ุฅุฏุฎุงู ุงููุต ุฏุงุฎู ุงูุนูุตุฑ ุจุฏูู ุชูุณูู
    });
});
</script>
<script src="../../static/js/voice_recorder.js"></script>
{% endblock %}
<!-- Copyright (c) 2024 by Timo Hausmann (https://codepen.io/timohausmann/pen/AaJWvo) -->