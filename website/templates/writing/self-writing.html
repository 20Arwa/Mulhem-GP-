{% extends "base.html" %}
{% block title %}الفرق بين الكتابة القصصية والإبداعية{% endblock %}
{% block styles %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/writing/self-writing.css') }}">
{% endblock %}
{% block body %}
<div class="container self-writing my-5">
	<div class="rounded-4 p-4 position-relative">
		<i class="fa-solid fa-square-plus add-page-icon position-absolute top-0 z-3" title="صفحة جديدة"></i>
		<i class="fa-solid fa-trash-can delete-page-icon position-absolute top-50 z-3" title="حذف الصفحة"></i>
		<form method="POST" id="self-writing">
			<div class="scene">
				<article class="book">
					<section class="page active">
						<div class="front">
							<h1>1</h1>
							<input class="button" type="text" name="title" placeholder="عنوان القصة" class="">
							<div class="cover-img-container img-container">
								<div class="rounded-4">
									<img class="img cover-img" src="" alt=""> 
								</div>
								<label for="cover-description">أدخل وصف الصورة</label>
								<textarea class="w-100 h-75 rounded-3" type="text" id="cover-description" placeholder="مثال:ولد صغير مرح بشعر مجعد يرتدي سترة زرقاء، ويقف تحت شجرة بأوراق خضراء متوهجة. في الخلفية، سماء زرقاء مع سحب بيضاء وأرنب لطيف يقفز بالقرب." ></textarea>
							</div>
						</div>
						<div class="back">
							<div class="text" contenteditable="true"></div>
							<div class="text-counter">عدد الأحرف: <span id="charCount">0</span>/<span id="maxLength">750</span><span id="error-msg">لقد وصلت إلى الحد الأقصى من الحروف. يمكنك إضافة صفحة جديدة للمتابعة.</span></div>
							<div class="correction-word" title="انقر للتصحيح"></div>
							<i class="fa-solid fa-volume-high"></i>
						</div>
					</section>
					<section class="page">
						<div class="front">
							<div class="cover-img-container img-container mt-5 mx-auto rounded-4">
								<img class="img rounded-4 cover-img w-100" src=""> 
							</div>
							<button class="generate-btn button my-5">أنشئ صورة</button>
						</div>
						<div class="back">
							<h1>صفحة 4</h1>
						</div>
					</section>
				</article>
			</div>
		</form>
		<!-- <div class="record">
			<i class="fa-solid fa-microphone mic-icon"></i>
			<p>سجل صوتك</p>
		</div> -->
		<div class="next-prev-buttons d-flex align-items-center justify-content-center">
			<!-- <button id="prevButton" class="button main-button">السابق</button> -->
			<!-- <button id="nextButton" class="button main-button">التالي</button> -->
			<button id="prevButton" class="button main-button "><i class="fa-solid fa-circle-right"></i>
				<button id="nextButton" class="button main-button"><i class="fa-solid fa-circle-left"></i>
				</button>
			</div>
			<div class="dropdown allam-help">
				<button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
					اطلب مساعدة مُلهِم
				</button>
				<ul class="dropdown-menu">
					<li><a class="dropdown-item correction" href="#allam-response">راجع قصتي وصحح أخطائي</a></li>
					<li><a class="dropdown-item starting" href="#">لا أعرف كيف أبدأ، ساعدني!</a></li>
					<!-- <li><a class="dropdown-item" href="#">Something else here</a></li> -->
				</ul>
			</div>
			<div class="allam-error"></div>
			<div class="allam-response-correction">


			</div>
	</div>
</div>
{% endblock %}
{% block script %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>

<script type="module">
document.addEventListener('DOMContentLoaded', function () {
	const addPageBtn = document.querySelector(".add-page-icon"); // Add Page Button
	const deletePageBtn = document.querySelector(".delete-page-icon"); // Delete Page Button

	const nextButton = document.getElementById('nextButton'); // Next Page Button
	const prevButton = document.getElementById('prevButton'); // Prev Page Button
	
	nextButton.addEventListener('click', nextPage);
	prevButton.addEventListener('click', prevPage);

	// @@@@@@@@@@@ Next Page Button @@@@@@@@@@@
	function nextPage() {
		const activePage = document.querySelector('.page.active');
		if (activePage) {
			const nextPage = activePage.nextElementSibling;
			
			// اجعل الصفحة النشطة مقلوبة
			activePage.classList.remove('active');
			activePage.classList.add('flipped');
			
			// تحقق إذا كانت الصفحة التالية موجودة
			if (nextPage && nextPage.classList.contains('page')) {
				nextPage.classList.add('active'); // اجعل الصفحة التالية نشطة
				
				// تحقق إذا كانت الصفحة الحالية هي الصفحة قبل الأخيرة
				const afterNextPage = nextPage.nextElementSibling;
				if (!afterNextPage || !afterNextPage.classList.contains('page')) {
					nextButton.classList.replace("fa-square-plus","fa-square-plus"); // Replace Next With Add Page
					addPageBtn.style.display = "block"; 
					nextButton.style.display = "none";
					console.log('أنت الآن على الصفحة قبل الأخيرة');
				} else {
					nextButton.style.display = "inline-block";
					document.querySelector(".add-page-icon").style.display = "none";
				}
			} else {
				console.log('لا توجد صفحة تالية.');
			}
		}
	}
	
	// @@@@@@@@@@@ Prev Page Button @@@@@@@@@@@
	function prevPage() {
		const flippedPages = document.querySelectorAll('.page.flipped');
		const activePage = document.querySelector('.page.active');

		// تحقق إذا كانت الصفحة الحالية هي قبل الأخيرة عند الضغط على السابق#############
const previousPage = activePage.previousElementSibling;
if (!previousPage || !previousPage.classList.contains('page')) {
    console.log("الصفحة الحالية هي الصفحة الأولى أو لا يوجد صفحة قبلها!");
} else {
    const beforePreviousPage = previousPage.previousElementSibling;
    if (!beforePreviousPage || !beforePreviousPage.classList.contains('page')) {
        console.log("الصفحة السابقة هي آخر صفحة (قبل الأولى)!");
    }
}


// تحقق إذا كانت الصفحة السابقة هي الصفحة الأخيرة###########
const previousPage = activePage.previousElementSibling;

if (previousPage && previousPage.classList.contains('page')) {
    const allPages = document.querySelectorAll('.page');
    const lastPage = allPages[allPages.length - 1];

    if (previousPage === lastPage) {
        console.log("الصفحة السابقة هي آخر صفحة في الكتاب!");
    }
} else {
    console.log("لا توجد صفحة سابقة أو الصفحة الحالية هي الأولى.");
}

		//##################  ذا حقي خطأ
		if (activePage.matches(":last-of-type")) { // ####### wrong
			nextButton.style.display = "none"; // Hide Next Button
			addPageBtn.style.display = "block"; // Display Add Page Button
			console.log("last")
		}
		else {
			nextButton.style.display = "inline-block"; // Display Next Button
			addPageBtn.style.display = "none"; // Hide Add Page Button

		}

		if (flippedPages.length > 0) {
			// اجعل آخر صفحة مقلوبة نشطة مرة أخرى
			const lastFlippedPage = flippedPages[flippedPages.length - 1];
			lastFlippedPage.classList.remove('flipped');
			lastFlippedPage.classList.add('active');
			
			// إزالة حالة النشط من جميع الصفحات الأخرى
			const allPages = document.querySelectorAll('.page');
			allPages.forEach((page) => {
				if (page !== lastFlippedPage) {
					page.classList.remove('active');
				}
			});
		}
	}
	
	// @@@@@@@@@@@ Add Page Button @@@@@@@@@@@
	addPageBtn.addEventListener("click", () => {
		const book = document.querySelector(".book");
		const newPage = document.createElement("section");
		newPage.className = "page"; // أضف فئة "page"
		newPage.innerHTML = `
			<div class='front'></div>
			<div class='back'></div>
			`; 
			book.appendChild(newPage); // أضف الصفحة الجديدة إلى الك
			nextPage();
		})
	// @@@@@@@@@@@ Delete Page Button @@@@@@@@@@@	
	deletePageBtn.addEventListener("click", () => {
		const currentSection = document.querySelector(".page.active");
		if (currentSection) {
			prevPage(); // انتقل إلى الصفحة السابقة إذا كانت موجودة
			currentSection.remove(); // حذف الصفحة الحالية بعد الانتقال
			addPageBtn.style.display = "none"; // Display Add Page Button
		} else {
			alert("لا توجد صفحة نشطة لحذفها!");
		}
	})


	// @@@@@@@@@@@ Recive And Send Data To Python @@@@@@@@@@@
	// @@@@@@@@@@@ Generate Image @@@@@@@@@@@
	async function sendTextGetImage() {
		const text = document.querySelector('.page.flipped .back textarea');
		const img = document.querySelector(".page.active .front img");

		// #############3 Validate text
		// ############ Send TO allam to make good promt?

		const data = { message: text.value }; // Corrected line
	
		const response = await fetch('http://127.0.0.1:5000/generate-img', {
			method: 'POST',
			headers: { 'Content-Type': 'application/json' },
			body: JSON.stringify(data)
		});
	
		if (response.ok) {
			const result = await response.json();
			console.log(result.response);
		} else {
			console.error(`Error: ${response.statusText}`);
		}
	}
	// Click Generate Image Button
	document.querySelector(".generate-btn").addEventListener("click", (e) => {
		e.preventDefault(); // Prevent page reload
		sendTextGetImage();
	});
	
	
	// @@@@@@@@@@@ Generate Audio @@@@@@@@@@@
	//async function sendTextGetAudio() {    }

	
	// @@@@@@@@@@@ Allam Correction @@@@@@@@@@@
	async function allamCorrection() {  
		var textElement = document.querySelector(".page.flipped .back .text");

		if (textElement.textContent.length < 20) {
			document.querySelector(".allam-error").innerHTML = "القصة قصيرة جدا! حاول كتابة المزيد لتحصل على التصحيح"
			return;
		}
		else {
			document.querySelector(".allam-error").innerHTML = "";
		}
		
		const data = { message: textElement.textContent }; 
		var result = "";
	
		const response = await fetch('http://127.0.0.1:5000/allam-correction', {
			method: 'POST',
			headers: { 'Content-Type': 'application/json' },
			body: JSON.stringify(data)
		});
	
		if (response.ok) {
			result = await response.json();

			// Spelling
			var spellings = result.response.spelling;
			let text = textElement.innerHTML;
			function highlightSpellingErrors(textElement, spellings) {
				const textContent = textElement.textContent; // النص الكامل
				const words = textContent.split(/(\s+|[,.!?؛؟])/); // تقسيم النص إلى كلمات وعلامات الترقيم
			
				// إنشاء محتوى جديد مع الأخطاء المحددة
				const newContent = words.map(word => {
					const spelling = spellings.find(sp => sp[0] === word); // البحث عن الكلمة في قائمة الأخطاء
					if (spelling) {
						// إذا كانت الكلمة خاطئة، إنشاء <span>
						const span = document.createElement("span");
						span.className = "spelling-error position-relative";
						span.dataset.suggestion = spelling[1];
						span.textContent = spelling[0];
						return span.outerHTML; // تحويل العنصر إلى نص HTML
					}
					return word; // الكلمة صحيحة تُترك كما هي
				}).join(''); // إعادة تجميع النصوص
			
				// استبدال النص في العنصر
				textElement.innerHTML = newContent;
			}
			// تطبيق الدالة
			highlightSpellingErrors(textElement, spellings);

			var correctionWord = document.querySelector(".back .correction-word")

			textElement.addEventListener('mouseover', (e) => {
				if (e.target.classList.contains('spelling-error')) {
					correctionWord.style.display = 'block';
					correctionWord.textContent = `الكلمة الصحيحة: ${e.target.dataset.suggestion}`;
			
					// إضافة حدث النقر لتعديل الكلمة المحددة فقط
					correctionWord.onclick = () => {
						e.target.textContent = e.target.dataset.suggestion;
						e.target.classList.remove('spelling-error');
						correctionWord.style.display = 'none';
					};
				}
			});
			// Grammer

		} else {
			console.error(`Error: ${response.statusText}`);
		}
	}


	// Click Correction Button
	document.querySelector(".dropdown.allam-help .correction").addEventListener("click", (e) => {
		e.preventDefault(); // Prevent page reload
		allamCorrection();
	});


	// Text Characters Counter 
	let maxLength = Number(document.querySelector(".back .text-counter #maxLength").textContent);
	let charCount = document.querySelector(".back .text-counter #charCount");

	document.querySelectorAll(".page .back .text").forEach((textElement) => {
		textElement.addEventListener('input', (event) => {
			let currentText = textElement.textContent;

			// إذا تجاوز النص الحد الأقصى
			if (currentText.length > maxLength) {
				textElement.textContent = currentText.slice(0, maxLength);// قطع النص إلى الحد الأقصى
				document.querySelector(".back .text-counter #error-msg").style.opacity = 1;
				
				// إعادة المؤشر إلى نهاية النص
				const range = document.createRange();
				const selection = window.getSelection();
				range.selectNodeContents(textElement);
				range.collapse(false);
				selection.removeAllRanges();
				selection.addRange(range);
				
			} else {
				document.querySelector(".back .text-counter #error-msg").style.opacity = 0;
			}
			
        // تحديث عداد الأحرف
        charCount.textContent = textElement.textContent.length;
    });
    // منع لصق النصوص التي تتجاوز الحد الأقصى
    textElement.addEventListener('paste', (event) => {
        event.preventDefault();
        let pastedText = event.clipboardData.getData('text').slice(0, maxLength - textElement.textContent.length);
        document.execCommand('insertText', false, pastedText);
    });
});

	// @@@@@@@@@@@ Text Sitting @@@@@@@@@@@
	// توحيد ستايل النص داخل صفحة الكتابة
	document.querySelector(".page .back .text").addEventListener('paste', (event) => {
        event.preventDefault(); // منع السلوك الافتراضي
        const text = (event.clipboardData || window.clipboardData).getData('text/plain');  // الحصول على النص الخام من الحافظة
        document.execCommand('insertText', false, text); // إدخال النص داخل العنصر بدون تنسيق
    });



	});

</script>
{% endblock %}

<!-- Copyright (c) 2024 by Timo Hausmann (https://codepen.io/timohausmann/pen/AaJWvo) -->

<!-- //document.querySelector(".page:nth-of-type(2) .front button").addEventListener("click", ()=> {
	//console.log("clickd")
	//sendTextGetImage()
//})
//function generate_img_btn() {
	//sendTextGetImage(); // هذا يتم استعدعاءه لما يضغط انشاء صورة
//} -->